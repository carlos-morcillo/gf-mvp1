<aside class="sidebar d-flex flex-column h-100">
  <div class="sidebar-header flex-shrink-0">
    <a routerLink="/" class="text-decoration-none fw-semibold fs-4">
      Greenfield<span class="text-success">&bull;</span>
    </a>
  </div>

  <div class="sidebar-body flex-grow-1 overflow-y-auto">
    <button
      class="btn btn-outline-success btn-sm w-100 mb-3"
      style="border-style: dashed;"
      routerLink="/private/agents/add"
      (click)="navigate.emit()"
    >
      <i class="bi bi-plus"></i>
      {{ 'sidebar.createNewAgent' | transloco }}
    </button>

    <ul class="nav flex-column">
      <li *ngFor="let item of menuItems" class="mb-1">
        <ng-container [ngSwitch]="item.id">
          <ng-container *ngSwitchCase="'chats'">
            <div class="collapsible-section">
              <button
                class="btn btn-link text-start w-100 d-flex align-items-center justify-content-between"
                (click)="toggleChatsCollapse()"
              >
                <div class="d-flex align-items-center">
                  <i class="bi bi-{{ item.icon }} me-2"></i>
                  <span>{{ item.label | transloco }}</span>
                </div>
                <i class="bi" [class.bi-chevron-down]="!chatsCollapsed()" [class.bi-chevron-right]="chatsCollapsed()"></i>
              </button>
              <div class="collapse" [class.show]="!chatsCollapsed()">
                <div class="pinned-chats-container">
                  <a
                    *ngFor="let chat of pinnedChats(); track chat.id"
                    [routerLink]="['/chats', chat.id]"
                    class="pinned-chat-item d-flex align-items-center p-2 text-decoration-none"
                    (click)="navigate.emit()"
                  >
                    <div class="chat-avatar me-2">
                      <i class="bi bi-chat-fill"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="chat-title">{{ chat.title }}</div>
                      <div class="chat-preview text-muted small">{{ chat.lastMessage }}</div>
                    </div>
                    <span *ngIf="chat.unreadCount" class="badge bg-primary rounded-pill">{{ chat.unreadCount }}</span>
                  </a>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-container *ngSwitchDefault>
            <a
              *ngIf="!item.isCollapsible"
              [routerLink]="item.route"
              routerLinkActive="nav-item-active"
              class="nav-link d-flex align-items-center"
              (click)="navigate.emit()"
            >
              <i class="bi bi-{{ item.icon }} me-2"></i>
              <span>{{ item.label | transloco }}</span>
            </a>
            <div *ngIf="item.isCollapsible" class="collapsible-section">
              <button
                class="btn btn-link text-start w-100 d-flex align-items-center justify-content-between"
                (click)="toggleAgentsCollapse()"
              >
                <div class="d-flex align-items-center">
                  <i class="bi bi-{{ item.icon }} me-2"></i>
                  <span>{{ item.label | transloco }}</span>
                </div>
                <i class="bi" [class.bi-chevron-down]="!agentsCollapsed()" [class.bi-chevron-right]="agentsCollapsed()"></i>
              </button>
              <div class="collapse" [class.show]="!agentsCollapsed()"></div>
            </div>
          </ng-container>
        </ng-container>
      </li>
    </ul>
  </div>

  <div class="sidebar-footer flex-shrink-0 p-2">
    <div class="dropdown dropup w-100">
      <button class="btn btn-link text-start w-100 d-flex align-items-center p-3" data-bs-toggle="dropdown">
        <img [src]="currentUser()?.avatar" class="rounded-circle me-2" width="32" height="32" />
        <div class="flex-grow-1 text-start">
          <div class="fw-semibold">{{ currentUser()?.name }}</div>
          <div class="text-muted small">{{ currentUser()?.email }}</div>
        </div>
        <i class="bi bi-three-dots-vertical"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end w-100">
        <li>
          <a class="dropdown-item" routerLink="/profile" (click)="navigate.emit()">
            <i class="bi bi-person me-2"></i>
            {{ 'sidebar.userMenu.profile' | transloco }}
          </a>
        </li>
        <li>
          <div class="dropdown-item-text">
            <div class="dropdown dropend w-100">
              <button class="btn btn-link text-start w-100 p-0 d-flex align-items-center justify-content-between" data-bs-toggle="dropdown">
                <span>
                  <i class="bi bi-globe me-2"></i>
                  {{ 'sidebar.userMenu.language' | transloco }}
                </span>
                <i class="bi bi-chevron-right"></i>
              </button>
              <ul class="dropdown-menu">
                <li *ngFor="let lang of languages">
                  <button class="dropdown-item" (click)="changeLanguage(lang.code)">
                    <span class="fi fi-{{ lang.code }} me-2"></span>
                    {{ lang.labelKey | transloco }}
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </li>
        <li><hr class="dropdown-divider" /></li>
        <li>
          <button class="dropdown-item text-danger" (click)="logout()">
            <i class="bi bi-box-arrow-right me-2"></i>
            {{ 'sidebar.userMenu.logout' | transloco }}
          </button>
        </li>
      </ul>
    </div>
  </div>
</aside>
